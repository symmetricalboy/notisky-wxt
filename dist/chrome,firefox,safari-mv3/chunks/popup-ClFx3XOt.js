import{r as l,j as s,b as a,a as C,R as w}from"./browser-Bh6BCD6u.js";function S(){const[p,d]=l.useState([]),[b,j]=l.useState(!0),[x,u]=l.useState(!1),[y,m]=l.useState(!1);l.useEffect(()=>{(async()=>{try{j(!0);const c=async()=>{try{const t=await fetch("https://notisky.symm.app/api/status",{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors"});if(t.ok){const r=t.headers.get("content-type");if(r&&r.includes("application/json")){const n=await t.json();u(n.success===!0)}else console.error("Server returned non-JSON response"),u(!1)}else u(!1)}catch(t){console.error("Error checking server connection:",t),u(!1)}},{accounts:i=[]}=await a.storage.local.get("accounts"),o=(await a.tabs.query({active:!0,currentWindow:!0}))[0];if(o!=null&&o.url&&(o.url.includes("bsky.app")||o.url.includes("bsky.social")))try{await a.tabs.sendMessage(o.id,{action:"checkForUpdates"})}catch(t){console.log("Unable to refresh counts from Bluesky tab:",t)}const h=await a.storage.local.get(["notificationCounts","accountNotifications"]);if(h.accountNotifications&&Array.isArray(h.accountNotifications)){const t=i.map(r=>{const n=h.accountNotifications.find(k=>k.did===r.did);return{...r,counts:n?{notification:n.notification||0,message:n.message||0,total:(n.notification||0)+(n.message||0)}:{notification:0,message:0,total:0}}});d(t)}else{const t=h.notificationCounts||{notification:0,message:0,total:0};i.length>0?i.length===1?d([{...i[0],counts:t}]):d(i):d([])}await c()}catch(c){console.error("Error loading data:",c)}finally{j(!1)}})()},[]);const g=e=>{a.tabs.create({url:`https://bsky.app${e}`}),window.close()},N=()=>{a.runtime.openOptionsPage(),window.close()},v=async()=>{try{m(!0);const e=await a.runtime.sendMessage({action:"authenticate"});e.success?window.location.reload():(console.error("Authentication failed:",e.error),m(!1))}catch(e){console.error("Error during authentication:",e),m(!1)}},f=e=>e>99?"badge-counter large-number":"badge-counter";return s.jsxs("div",{className:"popup-container",children:[s.jsxs("div",{className:"popup-header",children:[s.jsx("img",{src:"/icon/48.png",alt:"Notisky Logo",className:"logo"}),s.jsx("h1",{children:"Notisky"})]}),b?s.jsxs("div",{className:"loading-container",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Checking for notifications..."})]}):y?s.jsxs("div",{className:"loading-container",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Authenticating..."})]}):s.jsx(s.Fragment,{children:p.length>0?s.jsxs("div",{className:"accounts-container",children:[p.map((e,c)=>s.jsxs("div",{className:"account-card",children:[s.jsx("div",{className:"account-header",children:s.jsxs("span",{className:"account-handle",children:["@",e.handle]})}),s.jsxs("div",{className:"notification-summary",children:[s.jsxs("div",{className:"count-container",children:[s.jsxs("div",{className:"count-item badge-container",onClick:()=>g(`/profile/${e.handle}/notifications`),children:[s.jsx("div",{className:"count-label",children:"Notifications"}),e.counts&&e.counts.notification>0&&s.jsx("div",{className:f(e.counts.notification),children:e.counts.notification>99?"99+":e.counts.notification})]}),s.jsxs("div",{className:"count-item badge-container",onClick:()=>g("/messages"),children:[s.jsx("div",{className:"count-label",children:"Messages"}),e.counts&&e.counts.message>0&&s.jsx("div",{className:f(e.counts.message),children:e.counts.message>99?"99+":e.counts.message})]})]}),s.jsxs("div",{className:"total-count badge-container",children:[s.jsx("span",{children:"Total:"}),e.counts&&e.counts.total>0&&s.jsx("div",{className:f(e.counts.total),children:e.counts.total>99?"99+":e.counts.total})]})]})]},c)),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button primary",onClick:()=>g("/"),children:"Open Bluesky"}),s.jsx("button",{className:"action-button secondary",onClick:N,children:"Settings"})]})]}):s.jsxs("div",{className:"no-accounts-container",children:[s.jsx("p",{children:"No Bluesky accounts found."}),s.jsxs("p",{className:"server-status",children:["Server status: ",x?s.jsx("span",{className:"status-online",children:"Online"}):s.jsx("span",{className:"status-offline",children:"Offline"})]}),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button primary",onClick:v,disabled:!x,children:"Connect Account"}),s.jsx("button",{className:"action-button secondary",onClick:N,children:"Settings"})]})]})})]})}C.createRoot(document.getElementById("root")).render(s.jsx(w.StrictMode,{children:s.jsx(S,{})}));
