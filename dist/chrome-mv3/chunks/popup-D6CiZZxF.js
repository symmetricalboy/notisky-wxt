import{r as u,j as s,b as c,a as S,R as C}from"./browser-Bh6BCD6u.js";function A(){const[j,m]=u.useState([]),[k,N]=u.useState(!0),[b,v]=u.useState(!1),[E,f]=u.useState(!1);u.useEffect(()=>{(async()=>{try{N(!0);const l=async()=>{let o=0,n=null;for(;o<3;){try{const t=new AbortController,g=setTimeout(()=>t.abort(),5e3);try{const a=await fetch("https://notisky.symm.app/api/health",{method:"GET",headers:{Accept:"application/json, text/plain, */*"},mode:"cors",signal:t.signal});if(clearTimeout(g),a.status>=200&&a.status<500){console.log(`Server is up (status: ${a.status})`),v(!0);return}else n=`Server error status: ${a.status}`,console.error(n)}catch(a){clearTimeout(g),n=a.message,a.name==="AbortError"?console.error("Server connection request timed out"):console.error("Fetch error:",a)}}catch(t){n=t instanceof Error?t.message:String(t),console.error("Error in server connection check:",t)}if(o++,o<3){const t=1e3*Math.pow(2,o-1);console.log(`Retrying connection check in ${t}ms (attempt ${o+1}/3)`),await new Promise(g=>setTimeout(g,t))}}console.error(`Server connection failed after 3 attempts. Last error: ${n}`),v(!1)},{accounts:d=[]}=await c.storage.local.get("accounts"),i=(await c.tabs.query({active:!0,currentWindow:!0}))[0];if(i!=null&&i.url&&(i.url.includes("bsky.app")||i.url.includes("bsky.social")))try{await c.tabs.sendMessage(i.id,{action:"checkForUpdates"})}catch(r){console.log("Unable to refresh counts from Bluesky tab:",r)}const h=await c.storage.local.get(["notificationCounts","accountNotifications"]);if(h.accountNotifications&&Array.isArray(h.accountNotifications)){const r=d.map(o=>{const n=h.accountNotifications.find(t=>t.did===o.did);return{...o,counts:n?{notification:n.notification||0,message:n.message||0,total:(n.notification||0)+(n.message||0)}:{notification:0,message:0,total:0}}});m(r)}else{const r=h.notificationCounts||{notification:0,message:0,total:0};d.length>0?d.length===1?m([{...d[0],counts:r}]):m(d):m([])}await l()}catch(l){console.error("Error loading data:",l)}finally{N(!1)}})()},[]);const p=e=>{c.tabs.create({url:`https://bsky.app${e}`}),window.close()},y=()=>{c.runtime.openOptionsPage(),window.close()},w=async()=>{try{f(!0);const e=await c.runtime.sendMessage({action:"authenticate"});e.success?window.location.reload():(console.error("Authentication failed:",e.error),f(!1))}catch(e){console.error("Error during authentication:",e),f(!1)}},x=e=>e>99?"badge-counter large-number":"badge-counter";return s.jsxs("div",{className:"popup-container",children:[s.jsxs("div",{className:"popup-header",children:[s.jsx("img",{src:"/icon/48.png",alt:"Notisky Logo",className:"logo"}),s.jsx("h1",{children:"Notisky"})]}),k?s.jsxs("div",{className:"loading-container",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Checking for notifications..."})]}):E?s.jsxs("div",{className:"loading-container",children:[s.jsx("div",{className:"loading-spinner"}),s.jsx("p",{children:"Authenticating..."})]}):s.jsx(s.Fragment,{children:j.length>0?s.jsxs("div",{className:"accounts-container",children:[j.map((e,l)=>s.jsxs("div",{className:"account-card",children:[s.jsx("div",{className:"account-header",children:s.jsxs("span",{className:"account-handle",children:["@",e.handle]})}),s.jsxs("div",{className:"notification-summary",children:[s.jsxs("div",{className:"count-container",children:[s.jsxs("div",{className:"count-item badge-container",onClick:()=>p(`/profile/${e.handle}/notifications`),children:[s.jsx("div",{className:"count-label",children:"Notifications"}),e.counts&&e.counts.notification>0&&s.jsx("div",{className:x(e.counts.notification),children:e.counts.notification>99?"99+":e.counts.notification})]}),s.jsxs("div",{className:"count-item badge-container",onClick:()=>p("/messages"),children:[s.jsx("div",{className:"count-label",children:"Messages"}),e.counts&&e.counts.message>0&&s.jsx("div",{className:x(e.counts.message),children:e.counts.message>99?"99+":e.counts.message})]})]}),s.jsxs("div",{className:"total-count badge-container",children:[s.jsx("span",{children:"Total:"}),e.counts&&e.counts.total>0&&s.jsx("div",{className:x(e.counts.total),children:e.counts.total>99?"99+":e.counts.total})]})]})]},l)),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button primary",onClick:()=>p("/"),children:"Open Bluesky"}),s.jsx("button",{className:"action-button secondary",onClick:y,children:"Settings"})]})]}):s.jsxs("div",{className:"no-accounts-container",children:[s.jsx("p",{children:"No Bluesky accounts found."}),s.jsxs("p",{className:"server-status",children:["Server status: ",b?s.jsx("span",{className:"status-online",children:"Online"}):s.jsx("span",{className:"status-offline",children:"Offline"})]}),s.jsxs("div",{className:"action-buttons",children:[s.jsx("button",{className:"action-button primary",onClick:w,disabled:!b,children:"Connect Account"}),s.jsx("button",{className:"action-button secondary",onClick:y,children:"Settings"})]})]})})]})}S.createRoot(document.getElementById("root")).render(s.jsx(C.StrictMode,{children:s.jsx(A,{})}));
